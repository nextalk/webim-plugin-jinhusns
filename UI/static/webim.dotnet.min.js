/*
 * Webim v1.0.2
 * http://www.webim20.cn/
 *
 * Copyright (c) 2010 Hidden
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Fri Dec 31 22:47:51 2010 +0800
 * Commit: c5c22d876981a94ab63c4504e5999471d1a1e243
 */
(function(H,c,l){function I(){return(new Date).getTime()}var w=Object.prototype.toString;function p(R){return w.call(R)==="[object Function]"}function t(R){return w.call(R)==="[object Array]"}function D(R){return R&&w.call(R)==="[object Object]"}function a(R){return(R||"").replace(/^\s+|\s+$/g,"")}function Q(R,U){var T=false;if(D(U)){R=R||{};for(var S in U){var V=U[S];if(R[S]!=V){T=T||{};T[S]=V}}}return T}function o(T){var R=[];if(T!=null){var S=T.length;if(S==null||typeof T==="string"||p(T)||T.setInterval){R[0]=T}else{while(S){R[--S]=T[S]}}}return R}function j(){var W=arguments[0]||{},U=1,V=arguments.length,R=false,T;if(typeof W==="boolean"){R=W;W=arguments[1]||{};U=2}if(typeof W!=="object"&&!p(W)){W={}}for(;U<V;U++){if((T=arguments[U])!=null){for(var S in T){var X=W[S],Y=T[S];if(W===Y){continue}if(R&&Y&&typeof Y==="object"&&!Y.nodeType){W[S]=j(R,X||(Y.length!=null?[]:{}),Y)}else{if(Y!==l){W[S]=Y}}}}}return W}function J(U,Y,T){var S,V=0,W=U.length,R=W===l||p(U);if(T){if(R){for(S in U){if(Y.apply(U[S],T)===false){break}}}else{for(;V<W;){if(Y.apply(U[V++],T)===false){break}}}}else{if(R){for(S in U){if(Y.call(U[S],S,U[S])===false){break}}}else{for(var X=U[0];V<W&&Y.call(X,V,X)!==false;X=U[++V]){}}}return U}function L(T,U){for(var R=0,S=U.length;R<S;R++){if(U[R]===T){return R}}return -1}function N(S,W,R){var T=[];for(var U=0,V=S.length;U<V;U++){if(!R!==!W(S[U],U)){T.push(S[U])}}return T}function u(R,W){var S=[],V;for(var T=0,U=R.length;T<U;T++){V=W(R[T],T);if(V!=null){S[S.length]=V}}return S.concat.apply([],S)}var r={option:function(T,U){var S=T,R=this;R.options=R.options||{};if(typeof T=="string"){if(U===l){return R.options[T]}S={};S[T]=U}j(R.options,S);return R},bind:function(T,S){var R=this,U=R._events=R._events||{};if(p(S)){U[T]=U[T]||[];U[T].push(S)}return this},trigger:function(W,T){var S=this,X=S._events=S._events||{},V=X[W];if(!V){return this}T=t(T)?T:o(T);for(var U=0,R=V.length;U<R;U++){V[U].apply(this,T)}return this},unbind:function(V,U){var S=this,W=S._events=S._events||{};if(!W[V]){return this}if(p(U)){var R=W[V];for(var T=R.length;T--;T){if(R[T]===U||R[T]===U._proxy){R.splice(T,1)}}}else{delete W[V]}return this},one:function(U,T){if(!p(T)){return this}var R=this,S=T._proxy=fun._proxy||function(){R.unbind(U,S);return T.apply(this,arguments)};R.bind(U,S)}};var P=/%20/g;function g(R){var T=[];if(typeof R=="object"){for(var S in R){T[T.length]=encodeURIComponent(S)+"="+encodeURIComponent(R[S])}return T.join("&").replace(P,"+")}return R}var e=I(),G=/\?/,E=/(\?|&)_=.*?(&|$)/,i={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return H.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest()},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}},C={},n={};function M(S,U,R,T){if(S.error){S.error.call(S.context||H,U,R,T)}}function q(S){try{return !S.status&&location.protocol==="file:"||(S.status>=200&&S.status<300)||S.status===304||S.status===1223||S.status===0}catch(R){}return false}function m(U,S){var T=U.getResponseHeader("Last-Modified"),R=U.getResponseHeader("Etag");if(T){C[S]=T}if(R){n[S]=R}return U.status===304||U.status===0}function s(W,U,T){var S=W.getResponseHeader("content-type"),R=U==="xml"||!U&&S&&S.indexOf("xml")>=0,V=R?W.responseXML:W.responseText;if(R&&V.documentElement.nodeName==="parsererror"){throw"parsererror"}if(T&&T.dataFilter){V=T.dataFilter(V,U)}if(typeof V==="string"){if(U==="json"){if(typeof f==="object"&&f.parse){V=f.parse(V)}else{V=(new Function("return "+V))()}}}return V}function F(R){j(i,R)}function x(ae){ae=j(true,ae,j(true,{},i,ae));var U,V,T=ae.context||H,Z=ae.type.toUpperCase();if(ae.data&&ae.processData&&typeof ae.data!=="string"){ae.data=g(ae.data)}if(ae.cache===false&&Z==="GET"){var Y=I();var X=ae.url.replace(E,"$1_="+Y+"$2");ae.url=X+((X===ae.url)?(G.test(ae.url)?"&":"?")+"_="+Y:"")}if(ae.data&&Z==="GET"){ae.url+=(G.test(ae.url)?"&":"?")+ae.data}var S=false;var ad=ae.xhr();if(ae.username){ad.open(Z,ae.url,ae.async,ae.username,ae.password)}else{ad.open(Z,ae.url,ae.async)}try{if(ae.data){ad.setRequestHeader("Content-Type",ae.contentType)}if(ae.ifModified){if(C[ae.url]){ad.setRequestHeader("If-Modified-Since",C[ae.url])}if(n[ae.url]){ad.setRequestHeader("If-None-Match",n[ae.url])}}ad.setRequestHeader("X-Requested-With","XMLHttpRequest");ad.setRequestHeader("Accept",ae.dataType&&ae.accepts[ae.dataType]?ae.accepts[ae.dataType]+", */*":ae.accepts._default)}catch(W){}if(ae.beforeSend&&ae.beforeSend.call(T,ad,ae)===false){ad.abort();return false}var ab=function(af){if(!ad||ad.readyState===0){if(aa){clearInterval(aa);aa=null}}else{if(!S&&ad&&(ad.readyState===4||af==="timeout")){S=true;if(aa){clearInterval(aa);aa=null}U=af==="timeout"?"timeout":!q(ad)?"error":ae.ifModified&&m(ad,ae.url)?"notmodified":"success";if(U==="success"){try{V=s(ad,ae.dataType,ae)}catch(ag){U="parsererror"}}if(U==="success"||U==="notmodified"){ac()}else{M(ae,ad,U)}R();if(af){ad.abort()}if(ae.async){ad=null}}}};if(ae.async){var aa=setInterval(ab,13);if(ae.timeout>0){setTimeout(function(){if(ad&&!S){ab("timeout")}},ae.timeout)}}try{ad.send(Z==="POST"||Z==="PUT"?ae.data:null)}catch(W){M(ae,ad,null,W)}if(!ae.async){ab()}function ac(){if(ae.success){ae.success.call(T,V,U)}}function R(){if(ae.complete){ae.complete.call(T,ad,U)}}return ad}var A={url:location.href,timeout:5000,jsonp:"callback",async:false};var y=H.jsonpSupport={async:typeof(c.createElement("script").async)=="boolean",events:false,defaultAsync:false,fragmentProxy:false};(function(){var R=navigator.userAgent.toLowerCase();y.events=!/(opera)(?:.*version)?[ \/]([\w.]+)/.exec(R);y.defaultAsync=!!/(webkit)[ \/]([\w.]+)/.exec(R);var U=c.createDocumentFragment(),T=c.createElement("script");text="window.jsonpSupport.fragmentProxy = true";try{T.appendChild(c.createTextNode(text))}catch(S){T.text=text}U.appendChild(T);U=T=null})();function k(Y){Y=j({},A,Y);var ai="",S=/%20/g,al=Y.context||H,ak="jsonp"+e++,U=ak+"error",ah,af,V=H,W,ac,T=Y.async&&!y.fragmentProxy&&!y.defaultAsync&&!y.async;if(typeof Y.data=="object"){var aa=[];for(var aj in Y.data){aa[aa.length]=encodeURIComponent(aj)+"="+encodeURIComponent(Y.data[aj])}ai=ai+aa.join("&").replace(S,"+")}else{ai=ai+Y.data}ai=(ai?(ai+"&"):"")+(Y.jsonp||"callback")+"="+(T?"parent.":"")+ak;Y.url+=(/\?/.test(Y.url)?"&":"?")+ai;var Z=false;H[ak]=function(am){Y.success&&Y.success.call(al,am,"success");ag()};H[U]=function(am){if(!Z){ab("error");ag()}};if(Y.timeout>0){setTimeout(function(){if(!Z){ab("timeout");ag();H[ak]=K}},Y.timeout)}if(Y.async&&!y.defaultAsync&&y.fragmentProxy){ac=c.createDocumentFragment();W=ac}if(T){var R=H.location;if(Y.url.slice(0,1)=="/"){Y.url=R.protocol+"//"+R.host+(R.port?(":"+R.port):"")+Y.url}else{if(!/^https?:\/\//i.test(Y.url)){var ad=R.href,ae=/([^?#]+)\//.exec(ad);Y.url=(ae?ae[1]:ad)+"/"+Y.url}}ac=c.createElement("iframe");ac.style.position="absolute";ac.style.left="-100px";ac.style.top="-100px";ac.style.height="1px";ac.style.width="1px";ac.style.visibility="hidden";c.body.appendChild(ac);V=ac.contentWindow}T?setTimeout(function(){X()},0):X();return l;function X(){var am=V.document;W=W||am.getElementsByTagName("head")[0]||am.documentElement;ah=am.createElement("script");ah.src=Y.url;if(y.async){ah.async=Y.async}if(Y.scriptCharset){ah.charset=Y.scriptCharset}ah.onload=ah.onerror=ah.onreadystatechange=function(ap){if(!Z&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){ab("error");ag()}};W.insertBefore(ah,W.firstChild);if(!y.defaultAsync&&!y.events){var ao=am.createElement("script");var an="try{"+(T?"parent.":"")+U+"()}catch(e){};";ao.appendChild(c.createTextNode(an));W.insertBefore(ao,W.firstChild);W=ao=null}}function ag(){Z=true;H[ak]=l;try{delete H[ak]}catch(am){}H[U]=l;try{delete H[U]}catch(am){}ah.onload=ah.onreadystatechange=null;ah.parentNode&&ah.parentNode.removeChild(ah);ac&&ac.parentNode&&ac.parentNode.removeChild(ac);ah=ac=W=null}function ab(am){Y.error&&Y.error.call(al,am)}}function K(){}var f=(function(){var S={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function T(U){return S[U]||"\\u00"+Math.floor(U.charCodeAt()/16).toString(16)+(U.charCodeAt()%16).toString(16)}function R(Z){switch(Object.prototype.toString.call(Z)){case"[object String]":return'"'+Z.replace(/[\x00-\x1f\\"]/g,T)+'"';case"[object Array]":var V=[],U=Z.length;for(var Y=0;Y<U;Y++){V.push(R(Z[Y]))}return"["+V.join(",")+"]";case"[object Object]":var V=[];for(var X in Z){var W=R(Z[X]);if(W){V.push(R(X)+":"+W)}}return"{"+V+"}";case"[object Number]":case"[object Boolean]":return String(Z);case false:return"null"}return null}return{encode:R,decode:function(U){U=U.toString();if(!U||!U.length){return null}return(new Function("return "+U))()}}})();function z(T,S){var R=this;R._setting();R.options={jsonp:false,server:null,ticket:null,domain:null,timeout:40000,url:{send:null}};j(R.options,S)}j(z.prototype,r,{_setting:function(){var R=this;R.connected=false;R._connecting=false;R._onPolling=false;R._pollTimer=null;R._pollingTimes=0;R._failTimes=0},connect:function(T){var R=this;j(R.options,T);if(R._connecting){return R}R._connecting=true;var T=R.options,S=false,U=[];if(!R._onPolling){H.setTimeout(function(){R._startPolling()},300)}return R},close:function(){var R=this;if(R._pollTimer){clearTimeout(R._pollTimer)}R._setting();return R},_onConnect:function(){var R=this;R.connected=true;R.trigger("connect","success")},_onClose:function(R){var S=this;S._setting();S.trigger("close",[R])},_onData:function(S){var R=this;R.trigger("data",S)},_onError:function(S){var R=this;R._setting();R.trigger("error",S)},_startPolling:function(){var R=this,T=R.options;R._onPolling=true;R._pollingTimes++;var S=T.server;var U={domain:T.domain,ticket:T.ticket};var V={url:S,data:U,dataType:"json",timeout:T.timeout,cache:false,context:R,success:R._onPollSuccess,error:R._onPollError};if(T.jsonp){j(V,{timeout:T.timeout,async:true,dataType:"jsonp",jsonp:"callback"});k(V)}else{x(V)}},_onPollSuccess:function(S){var R=this;R._onPolling=false;if(R._connecting){if(!S||!S.status){return R._onError("error data")}else{if(R._pollingTimes==1){R._onConnect()}R._onData(S);R._failTimes=0;R._pollTimer=H.setTimeout(function(){R._startPolling()},200)}}},_onPollError:function(R){var S=this;S._onPolling=false;if(!S._connecting){return}if(S._pollingTimes==1){S._onError("can not connect.")}else{if(S._failTimes>1){}else{S._pollTimer=H.setTimeout(function(){S._startPolling()},200)}}}});function v(S,Z,ac){if(typeof Z!="undefined"){ac=ac||{};if(Z===null){Z="";ac=j({},ac);ac.expires=-1}var V="";if(ac.expires&&(typeof ac.expires=="number"||ac.expires.toUTCString)){var W;if(typeof ac.expires=="number"){W=new Date();W.setTime(W.getTime()+(ac.expires*24*60*60*1000))}else{W=ac.expires}V="; expires="+W.toUTCString()}var ab=ac.path?"; path="+(ac.path):"";var X=ac.domain?"; domain="+(ac.domain):"";var R=ac.secure?"; secure":"";c.cookie=[S,"=",encodeURIComponent(Z),V,ab,X,R].join("")}else{var U=null;if(c.cookie&&c.cookie!=""){var aa=c.cookie.split(";");for(var Y=0;Y<aa.length;Y++){var T=a(aa[Y]);if(T.substring(0,S.length+1)==(S+"=")){U=decodeURIComponent(T.substring(S.length+1));break}}}return U}}var O=true;function h(W,X){if(!O){return}var V=new Date(),T=["[",V.getHours(),":",V.getMinutes(),":",V.getSeconds(),"-",V.getMilliseconds(),"]"].join(""),U=T+X+f.encode(W);H.console&&H.console.log(T,X,W);var S=c.getElementById("webim-log")||c.body;H.air&&H.air.trace(U);if(S){var R=c.createElement("P");R.innerHTML=U;S.appendChild(R)}}h.enable=function(){O=true};h.disable=function(){O=false};function d(T,S){var R=this;R.options=j({},d.defaults,S);this._init(T,S)}j(d.prototype,r,{_init:function(){var S=this,T=S.options;var R={presence:"offline",show:"unavailable"};if(T.jsonp){S.request=k}else{S.request=x}S.data={user:R};S.status=new d.status();S.setting=new d.setting(null,{jsonp:T.jsonp});S.buddy=new d.buddy(null,{active:S.status.get("b"),jsonp:T.jsonp});S.room=new d.room(null,{user:R,jsonp:T.jsonp});S.history=new d.history(null,{user:R,jsonp:T.jsonp});S.connection=new z(null,{jsonp:true});S._initEvents()},user:function(R){j(this.data.user,R)},_ready:function(S){var R=this;R._unloadFun=H.onbeforeunload;H.onbeforeunload=function(){R._refresh()};R.trigger("ready",[S])},_go:function(){var Y=this,T=Y.data,U=Y.history,V=Y.buddy,R=Y.room;U.option("userInfo",T.user);var S=[];J(T.buddies,function(ab,aa){U.init("chat",aa.id,aa.history)});V.handle(T.buddies);J(T.rooms,function(ab,aa){U.init("grpchat",aa.id,aa.history)});var W=Y.setting.get("blocked_rooms"),Z=T.rooms;t(W)&&Z&&J(W,function(ab,aa){Z[aa]&&(Z[aa].blocked=true)});R.handle(Z);R.options.ticket=T.connection.ticket;Y.trigger("go",[T]);Y.connection.connect(T.connection);var X=T.new_messages;if(X&&X.length){J(X,function(ab,aa){aa["new"]=true});Y.trigger("message",[X])}},_stop:function(S,T){var R=this;H.onbeforeunload=R._unloadFun;R.data.user.presence="offline";R.data.user.show="unavailable";R.buddy.clear();R.trigger("stop",[S,T])},autoOnline:function(){return !this.status.get("o")},_initEvents:function(){var U=this,S=U.status,W=U.setting,X=U.history,T=U.connection,V=U.buddy;T.bind("connect",function(Z,Y){}).bind("data",function(Y){U.handle(Y)}).bind("error",function(Y){U._stop("connect","Connect Error")}).bind("close",function(Y){U._stop("connect","Disconnect")});U.bind("message",function(ab){var ae=[],aa=ab.length,ad=U.data.user.id,ag,Y,af;for(var ac=0;ac<aa;ac++){ag=ab[ac];af=ag.type;Y=af=="chat"?(ag.to==ad?ag.from:ag.to):ag.to;ag.id=Y;if(af=="chat"&&!ag["new"]){var Z={id:Y,presence:"online"};if(ag.nick){Z.nick=ag.nick}ae.push(Z)}}if(ae.length){V.presence(ae);V.complete()}X.handle(ab)});function R(Y){var Z={id:Y.from,presence:Y.type};if(Y.show){Z.show=Y.show}if(Y.nick){Z.nick=Y.nick}if(Y.status){Z.status=Y.status}return Z}U.bind("presence",function(Y){V.presence(u(Y,R))})},handle:function(S){var R=this;S.messages&&S.messages.length&&R.trigger("message",[S.messages]);S.presences&&S.presences.length&&R.trigger("presence",[S.presences]);S.statuses&&S.statuses.length&&R.trigger("status",[S.statuses])},sendMsg:function(S){var R=this;S.ticket=R.data.connection.ticket;R.trigger("sendMsg",[S]);R.request({type:"post",url:R.options.urls.message,cache:false,data:S})},sendStatus:function(S){var R=this;S.ticket=R.data.connection.ticket;R.request({type:"post",url:R.options.urls.status,cache:false,data:S})},sendPresence:function(S){var R=this;S.ticket=R.data.connection.ticket;R.data.user.show=S.show;R.status.set("s",S.show);R.request({type:"post",url:R.options.urls.presence,cache:false,data:S})},online:function(W){var S=this,R=S.status;var T=[],V=[],U=R.get("tabs"),X=R.get("tabIds");if(X&&X.length&&U){J(U,function(Z,Y){if(Z[0]=="b"){T.push(Z.slice(2))}if(Z[0]=="r"){V.push(Z.slice(2))}})}W=j({buddy_ids:T.join(","),room_ids:V.join(","),show:R.get("s")||"available"},W);S._ready(W);R.set("o",false);R.set("s",W.show);S.request({type:"post",dataType:"json",data:W,url:S.options.urls.online,success:function(Y){if(!Y){S._stop("online","Not Found")}else{if(!Y.success){S._stop("online",Y.error_msg)}else{Y.user=j(S.data.user,Y.user,{presence:"online"});S.data=Y;S._go()}}},error:function(Y){S._stop("online","Not Found")}})},offline:function(){var R=this,S=R.data;R.status.set("o",true);R.connection.close();R._stop("offline","offline");R.request({type:"post",url:R.options.urls.offline,type:"post",cache:false,data:{status:"offline",ticket:S.connection.ticket}})},_refresh:function(){var R=this,S=R.data;if(!S||!S.connection||!S.connection.ticket){return}R.request({type:"post",url:R.options.urls.refresh,type:"post",cache:false,data:{ticket:S.connection.ticket}})}});function B(R){return R&&R.split?R.split(","):(t(R)?R:(parseInt(R)?[parseInt(R)]:[]))}function b(S,U,T){function R(X,W){var V=this;V.data=X;V.options=j({},R.defaults,W);p(V._init)&&V._init()}R.defaults=U;j(R.prototype,r,T);d[S]=R}H.webim=d;j(d,{version:"1.0.2",defaults:{urls:{online:"webim/online",offline:"webim/offline",message:"webim/message",presence:"webim/presence",refresh:"webim/refresh",status:"webim/status"}},log:h,idsArray:B,now:I,isFunction:p,isArray:t,isObject:D,trim:a,makeArray:o,extend:j,each:J,inArray:L,grep:N,map:u,JSON:f,ajax:x,jsonp:k,comet:z,model:b,objectExtend:r});b("setting",{url:"/webim/setting",data:{blocked_rooms:[],play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){var R=this;if(R.options.jsonp){R.request=k}else{R.request=x}R.data=j({},R.options.data,R.data)},get:function(R){return this.data[R]},set:function(V,X){var T=this,U=V;if(!V){return}if(typeof V=="string"){U={};U[V]=X}var S=T.data,R=Q(S,U);if(R){J(R,function(Y,Z){T.trigger("update",[Y,Z])});var W=j({},S,U);T.data=W;T.request({type:"post",url:T.options.url,dataType:"json",cache:false,data:{data:f.encode(W)}})}}});b("status",{key:"_webim"},{_init:function(){var R=this,S=R.data;if(!S){var T=v(R.options.key);R.data=T?f.decode(T):{}}else{R._save(S)}},set:function(U,W){var T=U,S=this;if(typeof U=="string"){T={};T[U]=W}var R=S.data;if(Q(R,T)){var V=j({},R,T);S._save(V)}},get:function(R){return this.data[R]},clear:function(){this._save({})},_save:function(R){this.data=R;v(this.options.key,f.encode(R),{path:"/",domain:c.domain})}});b("buddy",{url:"/webim/buddy"},{_init:function(){var R=this;if(R.options.jsonp){R.request=k}else{R.request=x}R.data=R.data||[];R.dataHash={};R.handle(R.data)},clear:function(){var R=this;R.data=[];R.dataHash={}},count:function(W){var V=this.dataHash,U=0,T;for(var S in V){if(D(W)){T=true;for(var R in W){if(W[R]!=V[S][R]){T=false}}if(T){U++}}else{U++}}return U},get:function(R){return this.dataHash[R]},complete:function(){var S=this,V=S.dataHash,U=[],R;for(var T in V){R=V[T];if(R.incomplete&&R.presence=="online"){R.incomplete=false;U.push(T)}}S.load(U)},update:function(R){this.load(R)},presence:function(V){var S=this,U=S.dataHash;V=t(V)?V:[V];for(var T in V){var R=V[T];R.presence=R.presence=="offline"?"offline":"online";R.incomplete=!U[R.id]}S.handle(V)},load:function(T){T=B(T);if(T.length){var R=this,S=R.options;R.request({type:"get",url:S.url,async:true,cache:false,dataType:"json",data:{ids:T.join(",")},context:R,success:R.handle})}},handle:function(S){var ab=this,V=ab.data,W=ab.dataHash,T={};S=S||[];var R=S.length,Z,X,aa;for(var U in S){Z=S[U],id=Z.id;if(id){if(!W[id]){Z.presence=Z.presence||"online";Z.show=Z.show?Z.show:(Z.presence=="offline"?"unavailable":"available");W[id]={};V.push(W[id])}Z.incomplete=!!Z.incomplete;aa=Q(W[id],Z);if(aa){X=aa.presence||"update";T[X]=T[X]||[];j(W[id],aa);T[X].push(W[id])}}}for(var Y in T){ab.trigger(Y,[T[Y]])}ab.options.active&&ab.complete()}});(function(){b("room",{urls:{join:"/webim/join",leave:"/webim/leave",member:"/webim/members"}},{_init:function(){var R=this;R.data=R.data||[];R.dataHash={};if(R.options.jsonp){R.request=k}else{R.request=x}},get:function(R){return this.dataHash[R]},block:function(U){var R=this,T=R.dataHash[U];if(T&&!T.blocked){T.blocked=true;var S=[];J(R.dataHash,function(W,V){if(V.blocked){S.push(V.id)}});R.trigger("block",[U,S])}},unblock:function(U){var R=this,T=R.dataHash[U];if(T&&T.blocked){T.blocked=false;var S=[];J(R.dataHash,function(W,V){if(V.blocked){S.push(V.id)}});R.trigger("unblock",[U,S])}},handle:function(V){var S=this,U=S.data,T=S.dataHash,R={};J(V,function(X,W){var Y=W.id;if(Y){W.members=W.members||[];W.count=W.count||0;W.all_count=W.all_count||0;if(!T[Y]){T[Y]=W;U.push(W)}else{j(T[Y],W)}S.trigger("join",[T[Y]])}})},addMember:function(U,W){var S=this;if(t(W)){J(W,function(Z,Y){S.addMember(U,Y)});return}var V=S.dataHash[U];if(V){var R=V.members,X;for(var T=R.length;T--;T){if(R[T].id==W.id){X=R[T]}}if(!X){W.nick=W.nick;R.push(W);V.count=R.length;S.trigger("addMember",[U,W])}}},removeMember:function(U,T){var V=this.dataHash[U];if(V){var R=V.members,W;for(var S=R.length;S--;S){if(R[S].id==T){W=R[S];R.splice(S,1);V.count--}}W&&self.trigger("removeMember",[U,W])}},initMember:function(S){var R=this.dataHash[S];if(R&&!R.initMember){R.initMember=true;this.loadMember(S)}},loadMember:function(T){var R=this,S=R.options;R.request({type:"get",async:true,cache:false,url:S.urls.member,dataType:"json",data:{ticket:S.ticket,id:T},success:function(U){R.addMember(T,U)}})},join:function(U){var S=this,T=S.options,R=T.user;S.request({cache:false,type:"post",async:true,url:T.urls.join,dataType:"json",data:{ticket:T.ticket,id:U,nick:R.nick},success:function(V){S.initMember(U);S.handle([V])}})},leave:function(V){var S=this,T=S.options,U=S.dataHash[V],R=T.user;if(U){U.initMember=false;S.request({cache:false,type:"post",url:T.urls.leave,data:{ticket:T.ticket,id:V,nick:R.nick}});S.trigger("leave",[U])}},clear:function(){}})})();b("history",{urls:{load:"webim/history",clear:"webim/clear_history",download:"webim/download_history"}},{_init:function(){var R=this;R.data=R.data||{};R.data.chat=R.data.chat||{};R.data.grpchat=R.data.grpchat||{};if(R.options.jsonp){R.request=k}else{R.request=x}},chat:function(R){return this.data.chat[R]},grpchat:function(R){return this.data.grpchat[R]},handle:function(U){var aa=this,W=aa.data,R={chat:{},grpchat:{}};U=o(U);var T=U.length,Z,S,X=aa.options.userInfo.id;if(!T){return}for(var V=0;V<T;V++){Z=U[V];Y=Z.type;S=Y=="chat"?(Z.to==X?Z.from:Z.to):Z.to;if(S&&Y){R[Y][S]=R[Y][S]||[];R[Y][S].push(Z)}}for(var Y in R){for(var S in R[Y]){var Z=R[Y][S];if(W[Y][S]){W[Y][S]=W[Y][S].concat(Z);aa._triggerMsg(Y,S,Z)}else{aa.load(Y,S)}}}},_triggerMsg:function(R,T,S){this.trigger(R,[T,S])},clear:function(T,U){var R=this,S=R.options;R.data[T][U]=[];R.trigger("clear",[T,U]);R.request({url:S.urls.clear,type:"post",cache:false,data:{type:T,id:U}})},download:function(Y,S){var aa=this,ab=aa.options,R=ab.urls.download,T=(new Date()).getTime(),W=c.createElement("iframe"),X=new Date(),U=[],V={id:S,type:Y,time:(new Date()).getTime(),date:X.getFullYear()+"-"+(X.getMonth()+1)+"-"+X.getDate()};for(var Z in V){U[U.length]=encodeURIComponent(Z)+"="+encodeURIComponent(V[Z])}R+=(/\?/.test(R)?"&":"?")+U.join("&");W.setAttribute("src",R);W.style.display="none";c.body.appendChild(W)},init:function(S,U,T){var R=this;if(t(T)){R.data[S][U]=T;R._triggerMsg(S,U,T)}},load:function(T,U){var R=this,S=R.options;R.data[T][U]=[];R.request({url:S.urls.load,async:true,cache:false,type:"get",dataType:"json",data:{type:T,id:U},success:function(V){R.init(T,U,V)}})}})})(window,document);
/*
 * Webim UI v3.0.1
 * http://www.webim20.cn/
 *
 * Copyright (c) 2010 Hidden
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Fri Dec 31 22:48:17 2010 +0800
 * Commit: c3e67de3718815747038c2d69985f528e1b86a72
 */
(function(an,K,u){var d=webim.log,aj=webim.idsArray,ao=webim.now,al=webim.isFunction,a=webim.isArray,C=webim.isObject,am=webim.trim,ag=webim.makeArray,W=webim.extend,at=webim.each,t=webim.inArray,k=webim.grep,f=webim.JSON,ak=webim.ajax,i=webim.jsonp,ai=webim.comet,y=webim.model,ae=webim.objectExtend,w=webim.map;function ar(){return false}function H(ax){var aw="";if(ax.length==0){return""}aw=ax.replace(/&/g,"&gt;");aw=aw.replace(/</g,"&lt;");aw=aw.replace(/>/g,"&gt;");aw=aw.replace(/    /g,"&nbsp;");aw=aw.replace(/\'/g,"&#39;");aw=aw.replace(/\"/g,"&quot;");aw=aw.replace(/\n/g,"<br />");return aw}function N(aw){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(aw)}function F(aw){return aw?aw.replace(/<(?:.|\s)*?>/g,""):""}function A(aw,aD,aB){if(!aw){return aw}var ay=0,ax=[],aC=aw.split(""),aA=aC.length;for(var az=0;az<aA;az++){if(ay>=aB||ay<aD){break}else{if(aC[az].charCodeAt(0)>255){ay+=2}else{ay++}ax.push(aC[az])}}return ax.join("")}function ah(aw){return aw?(aw.nodeType?aw:K.getElementById(aw)):null}function T(ay,ax){var aw=[];for(;ay;ay=ay.nextSibling){if(ay.nodeType==1&&ay!=ax){aw.push(ay)}}return aw}function af(aw){return T(aw.firstChild)}function av(ax,aw){return ax&&(new RegExp("(^|\\s+)"+aw+"(\\s+|$)").test(ax.className))}function ap(ax,aw){if(!ax){return}if(!av(ax,aw)){ax.className+=" "+aw}}function aq(ax,aw){ax&&(ax.className=ax.className.replace(new RegExp("(^|\\s+)("+aw.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function p(ay,aw,ax){ay&&(ay.className=ay.className.replace(new RegExp("(^|\\s+)("+aw.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+ax)}function ab(ay,ax,aw){M(ay,"mouseover",function(){ap(this,ax);aw&&(aq(this,aw))});M(ay,"mouseout",function(){aq(this,ax);aw&&(ap(this,aw))})}function v(ay,aw,ax){if(typeof ax==="boolean"){ax?ap(ay,aw):aq(ay,aw)}else{av(ay,aw)?aq(ay,aw):ap(ay,aw)}}function h(aw){aw&&aw.style&&(aw.style.display="block")}function Y(aw){aw&&aw.style&&(aw.style.display="none")}function J(aw){aw&&aw.parentNode&&(aw.parentNode.removeChild(aw))}function M(ay,ax,aw){if(ay.addEventListener){ay.addEventListener(ax,aw,false)}else{ay["e"+ax+aw]=aw;ay[ax+aw]=function(){return ay["e"+ax+aw](an.event)};ay.attachEvent("on"+ax,ay[ax+aw])}}function O(ay,ax,aw){if(ay.addEventListener){ay.removeEventListener(ax,aw,false)}else{ay.detachEvent("on"+ax,ay[ax+aw]);ay[ax+aw]=null}}function ac(aw){if(!aw){return}aw.stopPropagation&&aw.stopPropagation();aw.cancelBubble=true}function z(aw){if(!aw){return}aw.preventDefault&&aw.preventDefault();aw.returnValue=false}function S(aw){if(!aw.target){aw.target=aw.srcElement||K}if(aw.target.nodeType===3){aw.target=aw.target.parentNode}return aw.target}function aa(aw){aw.setAttribute("unselectable","off");aw.style.MozUserSelect="";O(aw,"selectstart",ar)}function q(aw){aw.setAttribute("unselectable","on");aw.style.MozUserSelect="none";M(aw,"selectstart",ar)}function x(aw){o();if(P){aw()}else{L.push(aw)}}var P=false,L=[];function X(){if(!P){P=true;if(L){var ax,aw=0;while((ax=L[aw++])){ax()}L=null}}}var B=false;function o(){if(B){return}B=true;if(K.readyState==="complete"){return X()}if(K.addEventListener){K.addEventListener("DOMContentLoaded",function(){K.removeEventListener("DOMContentLoaded",arguments.callee,false);X()},false)}else{if(K.attachEvent){K.attachEvent("onreadystatechange",function(){if(K.readyState==="complete"){K.detachEvent("onreadystatechange",arguments.callee);X()}});if(K.documentElement.doScroll&&an==an.top){(function(){if(P){return}try{K.documentElement.doScroll("left")}catch(aw){setTimeout(arguments.callee,0);return}X()})()}}}M(an,"load",X)}function s(aw){var ax=(new Date());ax.setTime(aw?(parseFloat(aw)+s.timeSkew):(new Date()).getTime());this.date=ax}s.timeSkew=0;s.init=function(aw){};W(s.prototype,{getTime:function(){var ay=this.date;var aw=ay.getHours();var ax="";var az=ay.getMinutes();if(az<10){az="0"+az}var aA=aw+":"+az+ax;return aA},getDay:function(ax){var az=this.date;if(ax){var aw=new Date();aw.setHours(0);aw.setMinutes(0);aw.setSeconds(0);aw.setMilliseconds(0);var ay=24*60*60*1000;var aA=aw.getTime()-az.getTime();if(aA<=0){return Q("dt:today")}else{if(aA<ay){return Q("dt:yesterday")}}}return Q("dt:monthdate",{month:Q(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][az.getMonth()]),date:az.getDate()})}});var m=(function(){var ay=true;var ax=function(az){try{K.getElementById("webim-flashlib").playSound(az?az:"/sound/sound.mp3")}catch(aA){}};var aw={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){ay=true},disable:function(){ay=false},init:function(aC){W(aw,aC);var az=aw.lib+"?_"+new Date().getTime();if(navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length){var aA='<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+az+'" />'}else{var aA='<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+az+'">				<param name="allowScriptAccess" value="always" />				<param name="movie" value="'+az+'" />				<param name="scale" value="noscale" />				</object>'}try{K.getElementById("webim-flashlib-c").innerHTML=aA}catch(aB){}},play:function(aA){var az=N(aA)?aA:aw[aA];ay&&ax(az)}}})();var Z=(function(){var ay=false;M(an,"focus",function(){ay=false});M(an,"blur",function(){ay=true});var az=K.title,aw=0,ax=false,aA=null;return function(aC,aB){if(!ay){return}if(aD){clearInterval(aD);aw=0;ax=false}var aD=setInterval(function(){aw++;ax=!ax;if(aw==aB||!ay){clearInterval(aD);aw=0;ax=false}if(ax){K.title="["+aC+"]"+az}else{K.title=az}},1500)}})();var e={};var D=function(ax,aw){return e[aw]||""};function Q(ay,ax,aw){aw=W({locale:Q.locale},aw);var aB=Q.dictionary[aw.locale];if(!C(aB)){aB={}}var aA=aB[ay]===u?ay:aB[ay];if(ax){e=ax;for(var az in ax){aA=aA.replace(/\{\{(.*?)\}\}/g,D)}}return aA}Q.locale="zh-CN";Q.dictionary={};Q.store=function(aw,ax){var ay=Q.dictionary;if(!C(ay[aw])){ay[aw]={}}W(ay[aw],ax)};function r(ay,ax){var aw=this;aw.element=ay;aw.options=W({},r.defaults,ax);aw._init()}W(r.prototype,ae,{render:function(){var aw=this,ax=aw.layout;aw.element.insertBefore(ax.element,aw.element.firstChild);setTimeout(function(){aw.initSound()},1000);ax.buildUI()},_init:function(){var ax=this,aw=ax.im=new webim(null,ax.options.imOptions),ay=ax.options,az=ax.layout=new r.layout(null,W({chatAutoPop:aw.setting.get("msg_auto_pop")},ay.layoutOptions));aw.setting.get("play_sound")?m.enable():m.disable();aw.setting.get("minimize_layout")?az.collapse():az.expand();ax._initEvents()},addApp:function(az,ay){var aA=r.apps[az];if(!aA){return}var ax=this,aw=ax.im;al(aA.init)&&aA.init.apply(ax,[ay]);al(aA.ready)&&aw.bind("ready",function(){aA.ready.apply(ax,arguments)});al(aA.go)&&aw.bind("go",function(){aA.go.apply(ax,arguments)});al(aA.stop)&&aw.bind("stop",function(){aA.stop.apply(ax,arguments)})},initSound:function(aw){m.init(aw||this.options.soundUrls)},_initEvents:function(){var aD=this,aB=aD.im,aA=aB.buddy,az=aB.history,ax=aB.status,aE=aB.setting,aC=aD.buddy,ay=aD.layout,aw=aB.room;aB.bind("ready",function(){ay.changeState("ready")}).bind("go",function(aF){ay.changeState("active");ay.option("user",aF.user);s.init(aF.server_time);aD._initStatus()}).bind("stop",function(aF){aF=="offline"&&ay.removeAllChat();ay.updateAllChat();ay.changeState("stop")});aE.bind("update",function(aF,aG){switch(aF){case"play_sound":(aG?m.enable():m.disable());break;case"msg_auto_pop":ay.option("chatAutoPop",aG);break;case"minimize_layout":(aG?ay.collapse():ay.expand());break}});aA.bind("online",function(aF){ay.updateChat("buddy",aF)}).bind("offline",function(aF){ay.updateChat("buddy",aF)}).bind("update",function(aF){ay.updateChat("buddy",aF)});aw.bind("addMember",function(aF,aG){var aH=ay.chat("room",aF);aH&&aH.addMember(aG.id,aG.nick,aG.id==aB.data.user.id)}).bind("removeMember",function(aF,aG){var aH=ay.chat("room",aF);aH&&aH.removeMember(aG.id,aG.nick)});ay.bind("collapse",function(){aE.set("minimize_layout",true)});ay.bind("expand",function(){aE.set("minimize_layout",false)});ay.bind("displayUpdate",function(aF){aD._updateStatus()});aB.bind("message",function(aJ){var aO=false,aH=aJ.length,aM,aL=aB.data.user.id,aG,aN,aK="+1";for(var aI=0;aI<aH;aI++){aM=aJ[aI];aG=aM.id,type=aM.type;aN=ay.chat(type,aG);aN&&aN.status("");if(!aN){if(aM.type==="chat"){aD.addChat(type,aG,null,null,aM.nick)}else{aD.addChat(type,aG)}aN=ay.chat(type,aG)}aN&&aE.get("msg_auto_pop")&&!ay.activeTabId&&ay.focusChat(aG);aN.window.notifyUser("information",aK);var aF=aN.window.pos;(aF==-1)&&ay.setNextMsgNum(aK);(aF==1)&&ay.setPrevMsgNum(aK);if(aM.from!=aL){aO=true}}if(aO){m.play("msg");Z(Q("new message"),5)}});aB.bind("status",function(aF){at(aF,function(aK,aH){var aG=aB.data.user.id;var aJ=aH.from;if(aG!=aH.to&&aG!=aH.from){aJ=aH.to}else{var aI=ay.chat("buddy",aJ);aI&&aI.status(aH.show)}})});az.bind("chat",function(aI,aG){var aH=ay.chat("chat",aI),aF="+"+aG.length;if(aH){aH.history.add(aG)}});az.bind("grpchat",function(aI,aG){var aH=ay.chat("grpchat",aI),aF="+"+aG.length;if(aH){aH.history.add(aG)}});az.bind("clear",function(aF,aH){var aG=ay.chat(aF,aH);aG&&aG.history.clear()})},__status:false,_initStatus:function(){var ay=this,aA=ay.layout;if(ay.__status){return aA.updateAllChat()}ay.__status=true;var ax=ay.im.status,az=ax.get("tabs"),aC=ax.get("tabIds"),aB=ax.get("p"),aw=ax.get("a");aC&&aC.length&&az&&at(az,function(aE,aD){var aG=aE.slice(2),aF=aE.slice(0,1);ay.addChat(aF,aG,{},{isMinimize:true});aA.chat(aE).window.notifyUser("information",aD.n)});aB&&(aA.prevCount=aB)&&aA._fitUI();aw&&aA.focusChat(aw)},addChat:function(aG,ay,aE,aA,ax){aG=c(aG);var aJ=this,aC=aJ.layout,aH=aJ.im,aD=aJ.im.history,aF=aH.buddy,aw=aH.room,aL=aJ.options;if(aC.chat(aG,ay)){return}if(aG=="room"){aE=W({},aL.roomChatOptions,aE);var aB=aD.grpchat(ay),az=aw.get(ay),aI=az||{id:ay,nick:ax||ay};aI.presence="online";aC.addChat(aG,aI,W({history:aB,block:true,emot:true,clearHistory:false,member:true,msgType:"grpchat"},aE),aA);if(!aB){aD.load("grpchat",ay)}var aK=aC.chat(aG,ay);aK.bind("sendMsg",function(aM){aH.sendMsg(aM);aD.handle(aM)}).bind("downloadHistory",function(aM){aD.download("grpchat",aM.id)}).bind("select",function(aM){aF.presence(aM);aF.complete();aJ.addChat("buddy",aM.id,null,null,aM.nick);aC.focusChat("buddy",aM.id)}).bind("block",function(aM){aw.block(aM.id)}).bind("unblock",function(aM){aw.unblock(aM.id)}).window.bind("close",function(){aK.options.info.blocked&&aw.leave(ay)});setTimeout(function(){if(aK.options.info.blocked){aw.join(ay)}else{aw.initMember(ay)}},500);a(aI.members)&&at(aI.members,function(aN,aM){aK.addMember(aM.id,aM.nick,aM.id==aH.data.user.id)})}else{aE=W({},aL.buddyChatOptions,aE);var aB=aD.chat(ay),az=aF.get(ay);var aI=az||{id:ay,nick:ax||ay};aC.addChat(aG,aI,W({history:aB,block:false,emot:true,clearHistory:true,member:false,msgType:"chat"},aE),aA);if(!az){aF.update(ay)}if(!aB){aD.load("chat",ay)}aC.chat(aG,ay).bind("sendMsg",function(aM){aH.sendMsg(aM);aD.handle(aM)}).bind("sendStatus",function(aM){aH.sendStatus(aM)}).bind("clearHistory",function(aM){aD.clear("chat",aM.id)}).bind("downloadHistory",function(aM){aD.download("chat",aM.id)})}},_updateStatus:function(){var ax=this,az=ax.layout,aw={},ay=az.panels;at(az.tabs,function(aC,aB){aw[aC]={n:aB._count()}});var aA={tabs:aw,tabIds:az.tabIds,p:az.prevCount,a:az.activeTabId};ax.im.status.set(aA)}});var g=function(aw,ax){if(ax===u){return parseInt(aw.innerHTML)}else{if(ax){ax=(typeof ax=="number")?ax:(parseInt(aw.innerHTML)+parseInt(ax));aw.innerHTML=ax.toString();h(aw)}else{aw.innerHTML="0";Y(aw)}}return ax};function ad(aC){var aA=aC.getElementsByTagName("*"),az,aD,ay={},aB=":",aw=aB.length;for(var ax=aA.length-1;ax>-1;ax--){az=aA[ax];aD=az.id;if(aD&&aD.indexOf(aB)==0){ay[aD.substring(aw,aD.length)]=az}}return ay}function U(ax){var aw=K.createElement("div");aw.innerHTML=ax;aw=aw.firstChild;return aw}var V=(function(){var ay=null,ax=/\<\%\=(.*?)\%\>/ig;function aw(aA,az){return ay&&ay[az]!=u?ay[az]:Q(az)}return function(aA,az){if(!aA){return""}ay=az;return aA.replace(ax,aw)}})();var E={add:function(ax,ay,aA){var az=r[ax].prototype;for(var aw in aA){az.plugins[aw]=az.plugins[aw]||[];az.plugins[aw].push([ay,aA[aw]])}},call:function(aw,ay,ax){var aA=aw.plugins[ay];if(!aA||!aw.element.parentNode){return}for(var az=0;az<aA.length;az++){if(aw.options[aA[az][0]]){aA[az][1].apply(aw.element,ax)}}}};var j=1;function l(ay,az,ax){function aw(aC,aB){var aA=this;aA.id=j++;aA.name=ay;aA.className="webim-"+ay;aA.options=W({},aw.defaults,aB);aA.element=aC||(aA.template&&U(aA.template()))||(aA.options.template&&U(V(aA.options.template)));if(aA.element){aA.options.className&&ap(aA.element,aA.options.className);aA.$=ad(aA.element)}al(aA._init)&&aA._init();al(aA._initEvents)&&aA._initEvents()}aw.defaults=az;W(aw.prototype,ae,l.prototype,ax);r[ay]=aw}W(l.prototype,{_init:function(){}});function c(aw){return aw=="b"||aw=="buddy"||aw=="chat"?"buddy":"room"}function n(aw,ax){r.apps[aw]=ax||{}}W(r,{version:"3.0.1",widget:l,app:n,plugin:E,i18n:Q,date:s,ready:x,createElement:U,defaults:{},apps:{}});webim.ui=r;l("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">						<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},{html:function(aw){return this.$.content.appendChild(aw)},subHeader:function(aw){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(aw)},_init:function(ay,ax){var aw=this,ax=aw.options,az=aw.$;ay=aw.element;ay.window=aw;ax.tabWidth&&(az.tab.style.width=ax.tabWidth+"px");ax.subHeader&&aw.subHeader(ax.subHeader);aw.title(ax.title,ax.icon);!ax.minimizable&&Y(az.minimize);!ax.maximizable&&Y(az.maximize);if(!ax.closeable){Y(az.tabClose);Y(az.close)}if(ax.isMinimize){aw.minimize()}else{aw.restore()}if(ax.onlyIcon){Y(az.tabTitle)}else{J(az.tabTip)}ax.count&&aw.notifyUser("information",ax.count);I(aw)},notifyUser:function(ax,ay){var aw=this,az=aw.$;if(ax=="information"){if(aw.isMinimize()){if(g(az.tabCount,ay)){ap(az.tab,"ui-state-highlight");aq(az.tab,"ui-state-default")}}}},_count:function(){return g(this.$.tabCount)},title:function(aB,ay){var aw=this,az=aw.$,aA=az.tabIcon;if(ay){if(N(ay)){aA.className="webim-icon";aA.style.backgroundImage="url("+ay+")"}else{aA.className="webim-icon webim-icon-"+ay}}az.tabTipC.innerHTML=aB;var ax=A(aB,0,aw.options.titleVisibleLength);az.tabTitle.innerHTML=ax;ax&&aB&&ax.length<aB.length&&az.tabTitle.setAttribute("title",aB);az.headerTitle.innerHTML=aB},_changeState:function(ay){var ax=this.element,aw=ay=="restore"?"normal":ay;p(ax,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+aw);this.trigger("displayStateChange",[ay])},active:function(){return av(this.element,"webim-window-active")},activate:function(){var aw=this;if(aw.active()){return}ap(aw.element,"webim-window-active");aw.trigger("activate")},deactivate:function(){var aw=this;if(!aw.active()){return}aq(aw.element,"webim-window-active");if(!aw.options.sticky){aw.minimize()}aw.trigger("deactivate")},_setVisibile:function(){var aw=this,ax=aw.$;p(ax.tab,"ui-state-default ui-state-highlight","ui-state-active");aw.activate();g(ax.tabCount,0)},maximize:function(){var aw=this;if(aw.isMaximize()){return}aw._setVisibile();aw._changeState("maximize")},restore:function(){var aw=this;if(av(aw.element,"webim-window-normal")){return}aw._setVisibile();aw._changeState("restore")},minimize:function(){var aw=this;if(aw.isMinimize()){return}p(aw.$.tab,"ui-state-active","ui-state-default");aw.deactivate();aw._changeState("minimize")},tabClose:function(){this.close()},close:function(){var aw=this;aw.trigger("close");J(aw.element)},_initEvents:function(){var aw=this,ay=aw.element,aA=aw.$,az=aA.tab;var ax=function(aC){ac(aC);z(aC)};var aB=function(aC){aw.minimize()};M(az,"click",function(aC){if(aw.isMinimize()){aw.restore()}else{aw.minimize()}ax(aC)});M(az,"mouseover",function(){ap(this,"ui-state-hover");aq(this,"ui-state-default")});M(az,"mouseout",function(){aq(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&ap(this,"ui-state-default")});M(az,"mousedown",ax);q(az);at(af(aA.actions),function(aD,aC){ab(aC,"ui-state-hover")});at(["minimize","maximize","close","tabClose"],function(aD,aC){M(aA[aC],"click",function(aE){if(!this.disabled){aw[aC]()}ax(aE)});M(aA[aC],"mousedown",ax)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(aw){return},isMaximize:function(){return av(this.element,"webim-window-maximize")},isMinimize:function(){return av(this.element,"webim-window-minimize")}});var I=(function(){var aw=false;var aA=function(){aw&&aw.deactivate();aw=false;return true};var ay=function(aC){var aB=this;aB&&aB!=aw&&aA()&&(aw=aB)};var az=function(aC){var aB=this;aB&&aw==aB&&(aw=false)};var ax=function(aB){if(aB.active()){aA();aw=aB}aB.bind("activate",ay);aB.bind("deactivate",az)};M(K,"mousedown",function(aD){aD=S(aD);var aB;while(aD){if(aD.id==":webim-window"){aB=aD;break}else{aD=aD.parentNode}}if(aB){var aC=aB.window;aC&&aC.activate()}else{aA()}});return function(aB){ax(aB)}})();l("layout",{template:'<div id="webim" class="webim webim-state-ready">                    <div class="webim-preload ui-helper-hidden-accessible">                    <div id="webim-flashlib-c">                    </div>                    </div><div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">                            <div id=":shortcut" class="webim-shortcut">                            </div>                            <div class="webim-layout-r">                            <div id=":panels" class="webim-panels">                                <div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">                                            <div id=":next" class="webim-window-tab webim-panels-next ui-state-default">                                                    <div id=":nextMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em class="ui-icon ui-icon-triangle-1-w"></em>                                                    <span id=":nextCount">0</span>                                            </div>                                </div>                                <div id=":tabsWrap" class="webim-panels-tab-wrap">                                        <div id=":tabs" class="webim-panels-tab">                                        </div>                                </div>                                <div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">                                            <div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">                                                    <div id=":prevMsgCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <span id=":prevCount">0</span>                                                    <em class="ui-icon ui-icon-triangle-1-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">                                            <div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">                                                    <em class="ui-icon ui-icon-circle-arrow-e"></em>                                            </div>                                </div>                                <div class="webim-window-tab-wrap webim-expand-wrap ui-widget">                                            <div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">                                                    <em class="ui-icon ui-icon-circle-arrow-w"></em>                                            </div>                                </div>                            </div>                            <div id=":widgets" class="webim-widgets">                            </div>                            </div>            </div></div>                    </div>',shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">                                                    <div class="webim-window-tab-tip">                                                            <strong><%=title%></strong>                                                    </div>                                                    <em class="webim-icon" style="background-image:url(<%=icon%>)"></em>                                            </a>                                            </div>'},{_init:function(ay,ax){var aw=this,ax=aw.options;W(aw,{window:an,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,prevCount:0});if(ax.unscalable){ap(this.$.layout,"webim-layout-unscalable")}ax.isMinimize&&aw.collapse()},changeState:function(aw){this.element.className="webim webim-state-"+aw},_ready:false,buildUI:function(az){var ax=this,ay=ax.$;var aw=(G()-45)-ay.shortcut.offsetWidth-ay.widgets.offsetWidth-70;ax.maxVisibleTabs=parseInt(aw/ax.tabWidth);ax._fitUI();ax._ready=true},_updatePrevCount:function(ax){var aE=this,aB=aE.tabIds,aC=aE.maxVisibleTabs,aA=aB.length,aw=ax,az=aE.prevCount;if(aA<=aC){return}if(!aw){az=aA-aC}else{var aD=0;for(var ay=0;ay<aA;ay++){if(aB[ay]==aw){aD=ay;break}}if(aD<=az){az=aD}else{if(aD>=az+aC){az=aD-aC+1}}}aE.prevCount=az},_setVisibleTabs:function(aF){var aH=this,aG=aH.prevCount,ax=aG+aH.maxVisibleTabs,aE=aH.tabs,aD=aH.tabIds;var aC=aD.length,aB=0,aw=0;for(var aA=0;aA<aC;aA++){var az=aE[aD[aA]];if(aA<aG||aA>=ax){if(aF){h(az.element)}else{if(aH.activeTabId==aD[aA]){az.minimize()}var ay=az._count();if(aA<aG){aw+=ay;az.pos=1}else{aB+=ay;az.pos=-1}Y(az.element)}}else{az.pos=0;h(az.element)}}if(!aF){aH.setNextMsgNum(aB);aH.setPrevMsgNum(aw)}},setNextMsgNum:function(aw){g(this.$.nextMsgCount,aw)},setPrevMsgNum:function(aw){g(this.$.prevMsgCount,aw)},slideing:false,_slide:function(aE){var aG=this,aF=aG.prevCount,aA=aG.nextCount;if((aA>0&&aE==-1)||(aF>0&&aE==1)){aG.slideing=true;if(aA==1&&aE==-1||aF==1&&aE==1){aG.slideing=false}aG._slideSetup(false);aG._setVisibleTabs(true);if(aE==-1){aG.nextCount--;aG.prevCount++}else{if(aE==1){aG.nextCount++;aG.prevCount--}}var aD=aG.$.tabs,aC=parseFloat(aD.style.left),ay=-1*aG.tabWidth*aG.nextCount,aw=parseInt(500/13),aB=1,az=(ay-aC)/aw;var ax=setInterval(function(){aD.style.left=aC+az*aB+"px";if(aB==aw){if(aG.slideing){aG._slide(aE)}else{aG._fitUI();aG._slideReset()}clearInterval(ax);return}aB++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(az){var ax=this,aA=ax.$,aw=aA.tabsWrap,ay=aA.tabs;if(!ax._tabsWidth){ax._tabsWidth=ay.clientWidth}if(az){ax._tabsWidth=null}aw.style.position=az?"":"relative";aw.style.overflow=az?"visible":"hidden";aw.style.width=az?"":ax._tabsWidth+"px";ay.style.width=az?"":ax.tabWidth*ax.tabIds.length+"px";ay.style.position=az?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var ay=this,aB=ay.tabIds,ax=ay.maxVisibleTabs,aw=aB.length,az=ay.prevCount,aA=ay.nextCount;if(aw<=ax){aA=0;az=0}else{aA=aw-ax-az;aA=aA<0?0:aA;az=aw-ax-aA}ay.prevCount=az;ay.nextCount=aA},_updateCountUI:function(){var aw=this,ay=aw.$,ax=aw.prevCount,az=aw.nextCount;if(az<=0){ap(ay.next,"ui-state-disabled")}else{aq(ay.next,"ui-state-disabled")}if(ax<=0){ap(ay.prev,"ui-state-disabled")}else{aq(ay.prev,"ui-state-disabled")}if(ax>0||az>0){ay.next.style.display="block";ay.prev.style.display="block"}else{Y(ay.next);Y(ay.prev)}ay.nextCount.innerHTML=az.toString();ay.prevCount.innerHTML=ax.toString()},_initEvents:function(){var aw=this,ay=aw.window,ax=aw.$;var az=false;M(ay,"resize",function(){if(az){az=true;aw.buildUI()}});M(ax.next,"mousedown",function(){aw._slide(-1)});M(ax.next,"mouseup",function(){aw._slideUp()});q(ax.next);M(ax.prev,"mousedown",function(){aw._slide(1)});M(ax.prev,"mouseup",function(){aw._slideUp()});q(ax.prev);M(ax.expand,"click",function(){if(!aw.isMinimize()){return false}aw.expand();aw.trigger("expand");return false});M(ax.collapse,"click",function(){if(aw.isMinimize()){return false}aw.collapse();aw.trigger("collapse");return false});ab(ax.collapse,"ui-state-hover","ui-state-default");ab(ax.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return av(this.$.layout,"webim-layout-minimize")},collapse:function(){var aw=this;if(aw.isMinimize()){return}ap(this.$.layout,"webim-layout-minimize")},expand:function(){var aw=this;if(!aw.isMinimize()){return}aq(aw.$.layout,"webim-layout-minimize")},_displayUpdate:function(aw){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){var aw=this,ay=aw.$,ax=ay.widgets;aw._updateCount();aw.$.tabs.style.left=-1*aw.tabWidth*aw.nextCount+"px";aw._updateCountUI();aw._setVisibleTabs();aw._displayUpdate()},_stickyWin:null,_widgetStateChange:function(ay,ax){var aw=this;if(ax!="minimize"){at(aw.widgets,function(az,aA){if(aA.window!=ay){aA.window.minimize()}})}aw._displayUpdate()},widget:function(aw){return this.widgets[aw]},addWidget:function(aB,ay,aA,aw){var ax=this,ay=W(ay,{closeable:false,subHeader:aB.header});var aC,az=aB.element;aC=new r.window(null,ay);aC.html(az);ax.$[aw?aw:"widgets"].insertBefore(aC.element,aA&&ax.widgets[aA]?ax.widgets[aA].window.element:null);aB.window=aC;aC.bind("displayStateChange",function(aD){ax._widgetStateChange(this,aD)});ax.widgets[aB.name]=aB},focusChat:function(az,aA){aA=b(az,aA);var ax=this,ay=ax.tabs[aA],aw=ax.panels[aA];ay&&ay.isMinimize()&&ay.restore();aw&&aw.focus()},chat:function(aw,ax){return this.panels[b(aw,ax)]},updateChat:function(aA,aB){aB=ag(aB);var ay=this,aC,ax=aB.length,aw;for(var az=0;az<ax;az++){aC=aB[az];aw=ay.panels[b(aA,aC.id)];aw&&aw.update(aC)}},updateAllChat:function(){at(this.panels,function(ax,aw){aw.update()})},_onChatClose:function(ax){var aw=this;aw.tabIds=k(aw.tabIds,function(ay,az){return ay!=ax});delete aw.tabs[ax];delete aw.panels[ax];aw._changeActive(ax,true);aw._fitUI()},_onChatChange:function(ay,ax){var aw=this;if(ax=="minimize"){aw._changeActive(ay,true);aw._displayUpdate()}else{aw._changeActive(ay);aw._fitUI()}},_changeActive:function(az,ay){var ax=this,aw=ax.activeTabId;if(ay){aw==az&&(ax.activeTabId=null)}else{aw&&aw!=az&&ax.tabs[aw].minimize();ax.activeTabId=az;ax._updatePrevCount(az)}},addChat:function(aB,ax,aD,ay){var aC=this,aA=aC.panels,aw=ax.id,aE;aw=b(aB,aw);if(!aA[aw]){var az=aC.tabs[aw]=new r.window(null,W({isMinimize:aC.activeTabId||!aC.options.chatAutoPop,tabWidth:aC.tabWidth-2,titleVisibleLength:9},ay)).bind("close",function(){aC._onChatClose(aw)}).bind("displayStateChange",function(aF){aC._onChatChange(aw,aF)});aC.tabIds.push(aw);aC.$.tabs.insertBefore(az.element,aC.$.tabs.firstChild);aE=aA[aw]=new r.chat(null,W({window:az,user:aC.options.user,info:ax},aD));!az.isMinimize()&&aC._changeActive(aw);aC._fitUI()}},removeChat:function(ax,ay){var aw=this.tabs[b(ax,ay)];aw&&aw.close()},removeAllChat:function(){at(this.tabs,function(ax,aw){aw.close()})},addShortcut:function(az){var ax=this;if(a(az)){at(az,function(aB,aA){ax.addShortcut(aA)});return}if(!C(az)){return}var ay=ax.$.shortcut,aw=ax.options.tpl_shortcut;if(ay.childNodes.length>ax.options.shortcutLength+1){return}aw=U(V(aw,{title:Q(az.title),icon:az.icon,link:az.link,target:az.isExtlink?"_blank":""}));ab(aw.firstChild,"ui-state-hover");ay.appendChild(aw)},addWindow:function(){new r.window(null,{})},online:function(){var aw=this,ax=aw.$},offline:function(){var aw=this,ax=aw.$}});function G(){return K.compatMode==="CSS1Compat"&&K.documentElement.clientWidth||K.body.clientWidth}function b(aw,ax){return ax?(aw=="b"||aw=="buddy"||aw=="chat"?("b_"+ax):("r_"+ax)):aw}l("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},{_init:function(){var aw=this,ay=aw.element,ax=aw.options;E.call(aw,"init",[null,aw.ui()])},clear:function(){var aw=this;aw.$.content.innerHTML="";aw.trigger("clear")},add:function(aA){aA=ag(aA);var ay=this,aw=aA.length,ax=[];if(!aw){return}for(var az=0;az<aw;az++){var aB=aA[az];ax.push(ay._renderMsg(aB))}ay.$.content.innerHTML+=ax.join("");ay.trigger("update")},_renderMsg:function(ax){var aI=this;ax=W({},ax);E.call(aI,"render",[null,aI.ui({msg:ax})]);var aC=ax.from,aD=ax.to,aA=ax.timestamp,az=ax.body,aF=true,aE=aI._lastLogItem,aH=[],ay=aI.options.info,aB=aI.options.user,aw;aw=ax.nick;if(aE&&aE.to==aD&&aE.from==aC&&aA-aE.timestamp<60000){aF=false}if(aF){aI._lastLogItem=ax;var aG=(new s(aA));aH.push('<h4><span class="webim-gray">');aH.push(aG.getDay(true));aH.push(" ");aH.push(aG.getTime());aH.push("</span>");aH.push(aw);aH.push('</h4><hr class="webim-line ui-state-default" />')}aH.push("<p>");aH.push(az);aH.push("</p>");return aH.join("")},_renderDateBreak:function(aB){var ay=this,aA=ay._lastLogItem,aw=new Date(),az=new Date(),ax=[];aw.setTime(aB);aA&&az.setTime(aA.timestamp);if(!aA||aw.getDate()!=az.getDate()||aw.getMonth()!=az.getMonth()){ax.push("<h5>");ax.push((new s(aB)).getDay(true));ax.push("</h5>")}return ax.join("")},ui:function(ax){var aw=this;return W({element:aw.element,$:aw.$},ax)},plugins:{}});var au=(function(){var aw;function ax(aA,az,aB){return'<a href="'+(az=="www."?("http://"+aA):aA)+'"'+aw+">"+aA+"</a>"}function ay(az,aA){aw+=" "+az+'="'+aA+'"'}return function(aA,az){aw="";az&&C(az)&&at(az,ay);return aA.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,ax)}})();r.history.defaults.parseMsg=true;E.add("history","parseMsg",{render:function(ax,aw){var ay=aw.msg.body;ay=H(ay);ay=au(ay,{target:"_blank"});aw.msg.body=ay}});r.history.defaults.emot=true;E.add("history","emot",{render:function(ax,aw){aw.msg.body=r.emot.parse(aw.msg.body)}});l("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(ax){var aw=this,ay=aw.element;at(ay.firstChild.childNodes,function(aA,az){M(az,"click",function(aB){aq(ay,"webim-emot-show");aw.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var ax=this,ay=ax.emots=webim.ui.emot.emots;var aw=[];aw.push('<ul class="ui-helper-clearfix">');at(ay,function(aC,az){var aB=az.src,aA=az.t?az.t:az.q[0];aw.push('<li><img src="');aw.push(aB);aw.push('" title="');aw.push(aA);aw.push('" alt="');aw.push(az.q[0]);aw.push('" rel="');aw.push(az.q[0]);aw.push('" /></li>')});aw.push("</ul>");return V(ax.options.template,{emots:aw.join("")})},toggle:function(){v(this.element,"webim-emot-show")}});W(r.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(ax){var ay=webim.ui.emot,az=ay._q={};ax=W({dir:"webim/static/emot/default"},ax);if(ax.emots){ay.emots=ax.emots}var aw=ax.dir+"/";at(ay.emots,function(aB,aA){if(aA&&aA.src){aA.src=aw+aA.src}aA&&aA.q&&at(aA.q,function(aD,aC){az[aC]=aB})})},parse:function(ay){var ax=webim.ui.emot._q,aw=webim.ui.emot.emots;ax&&at(ax,function(aE,aA){var aB=aw[aA],aD=aB.src,aC=aB.t?aB.t:aB.q[0],az=[];az.push('<img src="');az.push(aD);az.push('" title="');az.push(aC);az.push('" alt="');az.push(aB.q[0]);az.push('" />');aE=H(aE);aE=aE.replace(new RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");ay=ay.replace(new RegExp(aE,"g"),az.join(""))});return ay}});function R(aw){K.selection&&(this.caretPos=K.selection.createRange())}l("chat",{tpl_header:'<div><div id=":user" class="webim-user"> 			<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> 			<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> 		     </div></div>',template:'<div class="webim-chat"> 				<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div>                                                 <div id=":content" class="webim-chat-content">                                                                                                                 <div id=":status" class="webim-chat-status webim-gray"></div>                                                 </div>                                                 <div id=":actions" class="webim-chat-actions">                                                         <div id=":toolContent" class="webim-chat-tool-content"></div>                                                        <div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>                                                        <table class="webim-chat-t" cellSpacing="0">                                                                 <tr>                                                                         <td style="vertical-align:top;">                                                                         <em class="webim-icon webim-icon-chat-edit"></em>                                                                        </td>                                                                         <td style="vertical-align:top;width:100%;">                                                                         <div class="webim-chat-input-wrap">                                                                                <textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea>                                                                         </div>                                                                         </td>                                                                 </tr>                                                         </table>                                                 </div>                                         </div>'},{_init:function(){var aw=this,ay=aw.element,ax=aw.options,aA=aw.window=ax.window;var az=aw.history=new r.history(null,{user:ax.user,info:ax.info});aw.$.content.insertBefore(az.element,aw.$.content.firstChild);aw.header=U(V(ax.tpl_header));W(aw.$,ad(aw.header));if(aA){aA.subHeader(aw.header);aA.html(ay);aw._bindWindow()}if(ax.simple){Y(aw.header)}aw.update(ax.info);az.add(ax.history);E.call(aw,"init",[null,aw.ui()]);aw._adjustContent()},update:function(az){var aw=this;if(az){aw.option("info",az);aw.history.option("info",az);aw._updateInfo(az)}var ay=aw.options.user.presence=="online";var ax=aw.options.info.presence=="online";if(!ay){aw.notice(Q("user offline notice"))}else{if(!ax){aw.notice(Q("buddy offline notice",{name:aw.options.info.nick}))}else{aw.notice("")}}E.call(aw,"update",[null,aw.ui()])},focus:function(){var aw=this.$.input;an.setTimeout(function(){aw.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(aA,ax){var aw=this,ay=aw.$.notice,az=aw._noticeTime;if(az){clearTimeout(az)}if(!aA){aw._noticeTxt=null;Y(ay);return}if(ax){ay.innerHTML=aA;h(ay);setTimeout(function(){if(aw._noticeTxt){ay.innerHTML=aw._noticeTxt}else{Y(ay,500)}},ax)}else{aw._noticeTxt=aA;ay.innerHTML=aA;h(ay)}},_adjustContent:function(){var aw=this.$.content;aw.scrollTop=aw.scrollHeight},_fitUI:function(az){var aw=this,ay=aw.window,ax=aw.$;aw._adjustContent()},_bindWindow:function(){var aw=this,ax=aw.window;ax.bind("displayStateChange",function(ay){if(ay!="minimize"){an.setTimeout(function(){aw.$.input.focus()},0);aw._adjustContent()}})},_inputAutoHeight:function(){var ax=this.$.input,ay=ax[0].scrollTop;if(ay>0){var aw=ax.height();if(aw>32&&aw<100){ax.height(aw+ay)}}},_sendMsg:function(aA){var aw=this,ax=aw.options,ay=ax.info;var az={type:ax.msgType,to:ay.id,from:ax.user.id,nick:ax.user.nick,offline:ay.presence!="online",timestamp:(new Date()).getTime()-s.timeSkew,body:aA};E.call(aw,"send",[null,aw.ui({msg:az})]);aw.trigger("sendMsg",az)},_inputkeypress:function(az){var aw=this,ay=aw.$;if(az.keyCode==13){if(az.ctrlKey){aw.insert("\n",true);return true}else{var ax=S(az),aA=ax.value;if(am(aA).length){aw._sendMsg(aA);ax.value="";z(az)}}}else{aw._typing()}},_onFocusInput:function(ay){var aw=this,ax=S(ay);var az=an.getSelection?an.getSelection().toString():(K.selection?K.selection.createRange().text:"");if(!az){an.setTimeout(function(){aw.$.input.focus()},0)}},_initEvents:function(){var ay=this,az=ay.options,aA=ay.$,aB=Q("input notice"),aw="webim-gray",ax=aA.input;ay.history.bind("update",function(){ay._adjustContent()}).bind("clear",function(){ay.notice(Q("clear history notice"),3000)});M(ax,"keyup",function(){R.call(this)});M(ax,"click",R);M(ax,"select",R);M(ax,"focus",function(){aq(this,aw);if(this.value==aB){this.value=""}});M(ax,"blur",function(){if(this.value==""){ap(this,aw);this.value=aB}});M(ax,"keypress",function(aC){ay._inputkeypress(aC)});M(aA.content,"click",function(aC){ay._onFocusInput(aC)})},_updateInfo:function(ay){var aw=this,ax=aw.$;ax.userPic.setAttribute("href",ay.url);ax.userPic.firstChild.setAttribute("defaultsrc",ay.default_pic_url?ay.default_pic_url:"");setTimeout(function(){if(ay.pic_url||ay.default_pic_url){ax.userPic.firstChild.setAttribute("src",ay.pic_url||ay.default_pic_url)}},100);ax.userStatus.innerHTML=F(ay.status)||"&nbsp";aw.window.title(ay.nick,ay.show)},insert:function(aE,ax){var aG=this,aD=aG.$.input;aD.focus();if(!ax){aD.value=aE;return}if(!aE){aE=""}if(aD.setSelectionRange){var ay=aD.value,aF=aD.selectionStart,aw=aD.selectionEnd,aB=ay.substring(0,aF),aA=ay.substring(aw),aC=aE.length;aD.value=aB+aE+aA;aD.setSelectionRange(aF+aC,aF+aC)}else{if(K.selection){var az=aD.caretPos;if(az){az.text=aE;az.collapse();az.select()}else{aD.value+=aE}}else{aD.value+=aE}}},_statusText:"",sendStatus:function(aw){var ax=this;if(!aw||aw==ax._statusText||ax.options.info.presence=="offline"){return}ax._statusText=aw;ax.trigger("sendStatus",{to:ax.options.info.id,show:aw})},_checkST:false,_typing:function(){var aw=this;aw.sendStatus("typing");if(aw._checkST){clearTimeout(aw._checkST)}aw._checkST=an.setTimeout(function(){aw.sendStatus("clear")},6000)},_setST:null,status:function(aA){aA=aA||"clear";var ay=this,az=ay.$.status,aw=ay.options.info.nick,ax="";ax=aA=="clear"?"":aw+Q(aA);az.innerHTML=ax;ay._adjustContent();if(ay._setST){clearTimeout(ay._setST)}if(ax!=""){ay._setST=an.setTimeout(function(){az.innerHTML=""},10000)}},destroy:function(){this.window.close()},ui:function(ax){var aw=this;return W({self:aw,$:aw.$,history:aw.history},ax)},plugins:{}});r.chat.defaults.emot=true;E.add("chat","emot",{init:function(aA,az){var aw=az.self;var ay=new r.emot();ay.bind("select",function(aB){aw.focus();aw.insert(aB,true)});var ax=U(V('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));M(ax,"click",function(aB){z(aB);ay.toggle()});az.$.toolContent.appendChild(ay.element);az.$.tools.appendChild(ax)},send:function(ax,aw){}});r.chat.defaults.clearHistory=true;E.add("chat","clearHistory",{init:function(az,ay){var aw=ay.self;var ax=U(V('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));M(ax,"click",function(aA){z(aA);aw.trigger("clearHistory",[aw.options.info])});ay.$.tools.appendChild(ax)}});r.chat.defaults.block=true;E.add("chat","block",{init:function(aB,aA){var ay=aA.self;var az=ay.options.info.blocked,ax=ay.options.info.nick,aC=U('<a href="#chat-block" style="display:'+(az?"none":"")+'" title="'+Q("block group",{name:ax})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),aw=U('<a href="#chat-block" style="display:'+(az?"":"none")+'" title="'+Q("unblock group",{name:ax})+'"><em class="webim-icon webim-icon-block"></em></a>');M(aC,"click",function(aD){z(aD);Y(aC);h(aw);ay.trigger("block",[ay.options.info])});M(aw,"click",function(aD){z(aD);Y(aw);h(aC);ay.trigger("unblock",[ay.options.info])});aA.$.tools.appendChild(aC);aA.$.tools.appendChild(aw)}});r.chat.defaults.member=true;W(r.chat.prototype,{addMember:function(aC,ax,az){var ay=this,aA=ay.$.member,aw=ay.memberLi;if(aw[aC]){return}var aB=U('<li><a class="'+(az?"ui-state-disabled":"")+'" href="'+aC+'">'+ax+"</a></li>");M(aB.firstChild,"click",function(aD){z(aD);az||ay.trigger("select",[{id:aC,nick:ax}])});aw[aC]=aB;ay.$.member.appendChild(aB);ay.$.memberCount.innerHTML=parseInt(ay.$.memberCount.innerHTML)+1},removeMember:function(ay){var aw=this,ax=aw.memberLi[ay];if(ax){aw.$.member.removeChild(ax);delete aw.memberLi[ay];aw.$.memberCount.innerHTML=parseInt(aw.$.memberCount.innerHTML)-1}}});E.add("chat","member",{init:function(aA,az){var aw=az.self,ay=az.$;aw.memberLi={};var aB=U(V('<div class="webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul"></ul></div>')),ax=ad(aB);ay.member=ax.ul;ay.memberCount=ax.memberCount;ay.content.parentNode.insertBefore(aB,ay.content)}});r.chat.defaults.downloadHistory=true;E.add("chat","downloadHistory",{init:function(az,ay){var aw=ay.self;var ax=U(V('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));M(ax,"click",function(aA){z(aA);aw.trigger("downloadHistory",[aw.options.info])});ay.$.tools.appendChild(ax)}});n("setting",{init:function(ax){var aB=this,aw=aB.im,az=aw.setting,aA=aB.layout;var ay=aB.setting=new r.setting(null,ax);aA.addWidget(ay,{title:Q("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});az.bind("update",function(aC,aD){if(typeof aD!="object"){ay.check_tag(aC,aD)}});ay.bind("change",function(aC,aD){az.set(aC,aD)})},stop:function(){}});l("setting",{template:'<div id="webim-setting" class="webim-setting">			<ul id=":ul"><%=tags%></ul>		   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},template:function(){var ax=this,aw=[],ay=ax.options.data;ay&&at(ay,function(az,aA){if(aA&&typeof aA!="boolean"){return}aw.push(ax._check_tpl(az,aA))});return V(ax.options.template,{tags:aw.join("")})},_initEvents:function(){var aw=this,ay=aw.options.data,ax=aw.$;ay&&at(ay,function(az,aA){ax[az]&&aw._check_event(ax[az])})},_check_tpl:function(aw,ax){return V(this.options.tpl_check,{label:Q(aw),name:aw,checked:ax?'checked="checked"':""})},_check_event:function(ax){var aw=this;M(ax.firstChild,"click",function(ay){aw._change(this.name,this.checked)})},check_tag:function(ay,aB){var ax=this;if(C(ay)){at(ay,function(aC,aD){ax.check_tag(aC,aD)});return}var aA=ax.$,aw=aA[ay];if(aB&&typeof aB!="boolean"){return}if(aw){aw.firstChild.checked=aB;return}var az=aA[ay]=U(ax._check_tpl(ay,aB));ax._check_event(az);aA.ul.appendChild(az)},_change:function(aw,ax){this.trigger("change",[aw,ax])},destroy:function(){}});n("user",{init:function(ay){ay=ay||{};var az=this,ax=az.im;var aw=az.user=new r.user();ay.container&&ay.container.appendChild(aw.element);aw.bind("online",function(aA){ax.online(aA)}).bind("offline",function(){ax.offline()}).bind("presence",function(aA){ax.sendPresence(aA)});aw.update(ax.data.user)},ready:function(){},go:function(){this.user.update(this.im.data.user)},stop:function(aw){this.user.show("unavailable")}});l("user",{template:'<div>  		<div id=":user" class="webim-user"> 			<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> 				<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>					<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">						<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>						<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>						<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>						<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>						<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>					</p>				</div> 					<span id=":userStatus" title="" class="webim-user-status"></span> 						</div> 							</div>'},{_init:function(){var aw=this},_initEvents:function(){var aw=this,az=aw.$,ax=az.userShowTrigger,ay=az.userShowList;M(ax,"click",function(aA){ay.style.display=="block"?Y(ay):h(ay);z(aA)});at(af(ay),function(aB,aA){M(aA,"click",function(aC){aw._set(this.href.split("#")[1]);Y(ay);z(aC)})})},update:function(az){var aw=this,ax=az.show||"unavailable",ay=aw.$;aw.options.info=az;ay.userStatus.innerHTML=F(az.status)||"&nbsp;";ay.userNick.innerHTML=az.nick||"";ay.userPic.setAttribute("href",az.url);ay.userPic.firstChild.setAttribute("defaultsrc",az.default_pic_url?az.default_pic_url:"");setTimeout(function(){if(az.pic_url||az.default_pic_url){ay.userPic.firstChild.setAttribute("src",az.pic_url||az.default_pic_url)}},100);aw.show(ax)},show:function(ay){var aw=this,ax=Q(ay);aw.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+ay+'">'+ax+"</em>"+ax},_set:function(ax){var aw=this,ay=aw.options.info;aw.show(ax);if(!ay){if(ax!="unavailable"){aw.trigger("online",[{show:ax}])}}else{if(ay.show!=ax){if(ax=="unavailable"){aw.trigger("offline",[])}else{if(ay.show=="unavailable"){aw.trigger("online",[{show:ax}])}else{aw.trigger("presence",[{show:ax,status:ay.status}])}}}}},destroy:function(){}});n("login",{init:function(ay){ay=ay||{};var az=this,aw=az.im;var ax=az.login=new r.login(null,ay);ay.container&&ay.container.appendChild(ax.element);ax.bind("login",function(aA){aw.online(aA)})},go:function(){this.login.hide()},stop:function(aw,ax){}});l("login",{questions:null,notice:"",template:'<div>  		<div id=":login" class="webim-login"> 			<div class="webim-login-notice" id=":notice"></div>			<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>			<form id=":form">				<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>				<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>				<div id=":more">				<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>				<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>				</div>				<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>			</form>		</div>'},{_init:function(){var aw=this,ax=aw.options.questions,ay=aw.$;if(ax&&ax.length){at(ax,function(aB,az){var aA=K.createElement("option");aA.value=az[0];aA.innerHTML=az[1];ay.question.appendChild(aA)})}else{Y(ay.more)}ay.notice.innerHTML=aw.options.notice},_initEvents:function(){var aw=this,ax=aw.$;ab(ax.submit,"ui-state-hover");M(ax.form,"submit",function(ay){aw.trigger("login",[{username:ax.username.value,password:ax.password.value,question:ax.question.value,answer:ax.answer.value}]);z(ay)})},hide:function(){Y(this.element)},show:function(){h(this.element)},hideError:function(){Y(this.$.error)},showError:function(aw){var ax=this.$.error;ax.innerHTML=Q(aw);h(ax)},destroy:function(){}});n("buddy",{init:function(aE){aE=aE||{};var aA=this,aB=aA.im,az=aB.buddy,ay=aA.layout;var aD=aA.buddy=new r.buddy(null,W({title:Q("buddy")},aE));ay.addWidget(aD,W({title:Q("buddy"),icon:"buddy",sticky:aB.setting.get("buddy_sticky"),className:"webim-buddy-window",isMinimize:!aB.status.get("b"),titleVisibleLength:19},aE.windowOptions));if(!aE.disable_user){aA.addApp("user",aE.userOptions);if(aE.is_login){aD.window.subHeader(aA.user.element);aA.user._initElement=true}}if(!aE.is_login&&!aE.disable_login){aA.addApp("login",W({container:aD.$.content},aE.loginOptions))}aB.setting.bind("update",function(aF,aG){if(aF=="buddy_sticky"){aD.window.option("sticky",aG)}});aD.bind("select",function(aF){aA.addChat("buddy",aF.id);aA.layout.focusChat("buddy",aF.id)});aD.window.bind("displayStateChange",function(aF){if(aF!="minimize"){az.option("active",true);aB.status.set("b",1);az.complete()}else{aB.status.set("b",0);az.option("active",false)}});var aC=function(aF){return C(aF)?aF.id:aF};var ax=function(aF){return aF.show!="invisible"&&aF.presence=="online"};var aw=function(aF){return aF.show=="invisible"};az.bind("online",function(aF){aD.add(k(aF,ax))});az.bind("offline",function(aF){aD.remove(w(aF,aC))});az.bind("update",function(aF){aD.add(k(aF,ax));aD.update(k(aF,ax));aD.remove(w(k(aF,aw),aC))});aD.offline()},ready:function(){var ay=this,aw=ay.im,ax=aw.buddy,az=ay.buddy;Y(az.$.logo);az.online()},go:function(){var ay=this,aw=ay.im,ax=aw.buddy,az=ay.buddy;ay.user&&!ay.user._initElement&&az.window.subHeader(ay.user.element);az.titleCount();az.hideError()},stop:function(ay,aB){var az=this,aw=az.im,ax=aw.buddy,aA=az.buddy;aA.offline();if(ay=="online"||ay=="connect"){aA.showError(aB)}}});l("buddy",{template:'<div id="webim-buddy" class="webim-buddy">		<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>			<div class="webim-buddy-content" id=":content">				<div id=":logo" class="webim-buddy-logo">&nbsp;</div>				<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>				<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>					<ul id=":ul"></ul>						</div>							</div>',tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var aw=this,ax=aw.options;aw.groups={};aw.li={};aw.li_group={};aw.size=0;if(ax.disable_group){ap(aw.element,"webim-buddy-hidegroup")}if(ax.simple){ap(aw.element,"webim-buddy-simple")}},_initEvents:function(){var ax=this,aA=ax.$,az=aA.search,aw=aA.searchInput,aB=Q("search buddy"),ay="ui-state-active";M(az.firstChild,"click",function(){aw.focus()});aw.value=aB;M(aw,"focus",function(){ap(az,ay);if(this.value==aB){this.value=""}});M(aw,"blur",function(){aq(az,ay);if(this.value==""){this.value=aB}});M(aw,"keyup",function(){var aC=ax.li,aD=this.value;at(ax.li,function(aF,aE){if(aD&&(aE.text||aE.innerHTML.replace(/<[^>]*>/g,"")).indexOf(aD)==-1){Y(aE)}else{h(aE)}})})},titleCount:function(){var aw=this,ay=aw.size,aA=aw.window,az=aw.$.empty,ax=aw.element;aA&&aA.title(aw.options.title+"("+(ay?ay:"0")+")");if(!ay){h(az)}else{Y(az)}if(ay>8){aw.scroll(true)}else{aw.scroll(false)}},scroll:function(aw){v(this.element,"webim-buddy-scroll",aw)},_time:null,_titleBuddyOnline:function(ax){var aw=this,ay=aw.window;if(!ax){ax=""}if(aw._time){clearTimeout(aw._time)}aw._time=setTimeout(function(){aw.titleCount()},5000)},_title:function(aw){var ax=this.window;if(ax){ax.title(this.options.title+"["+Q(aw)+"]")}},notice:function(ay,ax){var aw=this;switch(ay){case"buddyOnline":aw._titleBuddyOnline(ax);break;default:aw._title(ay)}},online:function(){var aw=this,ax=aw.$,ay=aw.window;aw.notice("connect");Y(ax.empty)},offline:function(){var aw=this,ax=aw.$,ay=aw.window;aw.scroll(false);aw.removeAll();Y(ax.empty);h(ax.logo);aw.notice("offline")},_updateInfo:function(ax,ay){ax=ax.firstChild;ax.setAttribute("href",ay.url);ax=ax.firstChild;var aw=ay.show?ay.show:"available";ax.className="webim-icon webim-icon-"+aw;ax.setAttribute("title",Q(aw));ax=ax.nextSibling;ax.setAttribute("defaultsrc",ay.default_pic_url?ay.default_pic_url:"");if(ay.pic_url||ay.default_pic_url){ax.setAttribute("src",ay.pic_url||ay.default_pic_url)}ax=ax.nextSibling;ax.innerHTML=ay.nick;ax=ax.nextSibling;ax.innerHTML=F(ay.status)||"&nbsp;";return ax},_addOne:function(az,aB){var aH=this,aF=aH.li,aw=az.id,aC=aH.$.ul;if(!aF[aw]){aH.size++;if(!az.default_pic_url){az.default_pic_url=""}az.status=F(az.status)||"&nbsp;";az.show=az.show||"available";az.human_show=Q(az.show);az.pic_url=az.pic_url||"";var ax=aF[aw]=U(V(aH.options.tpl_li,az));var aD=ax.firstChild;M(aD,"click",function(aI){z(aI);aH.trigger("select",[az]);this.blur()});var ay=aH.groups,aA=Q(az.group||"friend"),aE=ay[aA];if(!aE){var aG=U(V(aH.options.tpl_group));Y(aG);if(aA==Q("stranger")){aB=true}if(aB){aC.appendChild(aG)}else{aC.insertBefore(aG,aC.firstChild)}aE={name:aA,el:aG,count:0,title:aG.firstChild,li:aG.lastChild};aH.groups[aA]=aE}if(aE.count==0){h(aE.el)}aH.li_group[aw]=aE;aE.li.appendChild(ax);aE.count++;aE.title.innerHTML=aA+"("+aE.count+")"}},_updateOne:function(ay){var ax=this,aw=ax.li,az=ay.id;aw[az]&&ax._updateInfo(aw[az],ay)},update:function(ax){ax=ag(ax);for(var aw=0;aw<ax.length;aw++){this._updateOne(ax[aw])}},add:function(ay,aw){ay=ag(ay);for(var ax=0;ax<ay.length;ax++){this._addOne(ay[ax],aw)}this.titleCount()},removeAll:function(){var ay=[],aw=this.li;for(var ax in aw){ay.push(ax)}this.remove(ay);this.titleCount()},remove:function(aA){var ax=this,aD,az,aw=ax.li,aC,aB=ax.li_group;aA=aj(aA);for(var ay=0;ay<aA.length;ay++){aD=aA[ay];az=aw[aD];if(az){ax.size--;aC=aB[aD];if(aC){aC.count--;if(aC.count==0){Y(aC.el)}aC.title.innerHTML=aC.name+"("+aC.count+")"}J(az);delete (aw[aD])}}ax.titleCount()},select:function(ay){var aw=this,ax=aw.li[ay];ax&&ax.firstChild.click();return ax},hideError:function(){Y(this.$.error)},showError:function(aw){var ax=this.$.error;ax.innerHTML=Q(aw);h(ax)},destroy:function(){}});n("room",{init:function(){var aC=this,aw=aC.im,aD=aw.room,aA=aw.setting,ay=aw.data.user,aB=aC.layout;var ax=aC.room=new webim.ui.room(null).bind("select",function(aE){aC.addChat("room",aE.id);aC.layout.focusChat("room",aE.id)});aB.addWidget(ax,{title:Q("room"),icon:"room",sticky:aw.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true},"notification");aw.setting.bind("update",function(aE,aF){if(aE=="buddy_sticky"){ax.window.option("sticky",aF)}});aD.bind("join",function(aE){az(aE)}).bind("leave",function(aE){}).bind("block",function(aF,aE){aA.set("blocked_rooms",aE);az(aD.get(aF));aD.leave(aF)}).bind("unblock",function(aF,aE){aA.set("blocked_rooms",aE);az(aD.get(aF));aD.join(aF)}).bind("addMember",function(aE,aF){az(aD.get(aE))}).bind("removeMember",function(aE,aF){az(aD.get(aE))});function az(aF){var aE=aF.nick;aF=W({},aF,{group:"group",nick:aE+"("+(parseInt(aF.count)+"/"+parseInt(aF.all_count))+")"});aB.updateChat(aF);aF.blocked&&(aF.nick=aE+"("+Q("blocked")+")");ax.li[aF.id]?ax.update(aF):ax.add(aF)}},ready:function(){},go:function(){},stop:function(){}});l("room",{template:'<div id="webim-room" class="webim-room">		<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>			<div class="webim-room-content">				<div id=":empty" class="webim-room-empty"><%=empty room%></div>					<ul id=":ul"></ul>						</div>							</div>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){var aw=this;aw.size=0;aw.li={};aw._count=0;h(aw.$.empty)},_initEvents:function(){var ax=this,aA=ax.$,az=aA.search,aw=aA.searchInput,aB=Q("search room"),ay="ui-state-active";M(az.firstChild,"click",function(){aw.focus()});aw.value=aB;M(aw,"focus",function(){ap(az,ay);if(this.value==aB){this.value=""}});M(aw,"blur",function(){aq(az,ay);if(this.value==""){this.value=aB}});M(aw,"keyup",function(){var aC=ax.li,aD=this.value;at(ax.li,function(aF,aE){if(aD&&(aE.text||aE.innerHTML.replace(/<[^>]*>/g,"")).indexOf(aD)==-1){Y(aE)}else{h(aE)}})})},scroll:function(aw){v(this.element,"webim-room-scroll",aw)},_updateInfo:function(aw,ax){aw=aw.firstChild;aw.setAttribute("href",ax.url);aw=aw.firstChild;aw.setAttribute("defaultsrc",ax.default_pic_url?ax.default_pic_url:"");aw.setAttribute("src",ax.pic_url);aw=aw.nextSibling;aw.innerHTML=ax.nick;return aw},_addOne:function(aC,ay){var az=this,aw=az.li,aD=aC.id,aA=az.$.ul;az.size++;if(!aw[aD]){if(!aC.default_pic_url){aC.default_pic_url=""}var aB=aw[aD]=U(V(az.options.tpl_li,aC));var ax=aB.firstChild;M(ax,"click",function(aE){z(aE);az.trigger("select",[aC]);this.blur()});aA.appendChild(aB)}},_updateOne:function(ay){var ax=this,aw=ax.li,az=ay.id;aw[az]&&ax._updateInfo(aw[az],ay)},update:function(ax){ax=ag(ax);for(var aw=0;aw<ax.length;aw++){this._updateOne(ax[aw])}},add:function(ay){var aw=this;Y(aw.$.empty);ay=ag(ay);for(var ax=0;ax<ay.length;ax++){aw._addOne(ay[ax])}if(aw.size>8){aw.scroll(true)}},removeAll:function(){var ay=[],aw=this.li;for(var ax in aw){ay.push(ax)}this.remove(ay)},remove:function(az){var aA,ay,aw=this.li;az=aj(az);for(var ax=0;ax<az.length;ax++){aA=az[ax];ay=aw[aA];if(ay){J(ay);delete (aw[aA])}}},select:function(ay){var aw=this,ax=aw.li[ay];ax&&ax.firstChild.click();return ax},destroy:function(){}});n("menu",{init:function(aw){var az=this,ay=az.layout;var ax=az.menu=new r.menu(null,aw);ay.addWidget(ax,{title:Q("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")}});l("menu",{template:'<div id="webim-menu" class="webim-menu">		<ul id=":ul"><%=list%></ul>			<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>				</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var aw=this,ay=aw.element,ax=aw.options;var az=ax.window;ax.data&&ax.data.length&&Y(aw.$.empty)},template:function(){var ax=this,aw=[],ay=ax.options.data;ay&&at(ay,function(az,aA){aw.push(ax._li_tpl(aA))});return V(ax.options.template,{list:aw.join("")})},_li_tpl:function(aw){return V(this.options.tpl_li,{title:Q(aw.title),icon:aw.icon,link:aw.link,target:aw.isExtlink?"_blank":""})},_fitUI:function(){var aw=this.element;if(aw.clientHeight>300){aw.style.height=300+"px"}},add:function(ay){var aw=this;if(a(ay)){at(ay,function(az,aA){aw.add(aA)});return}var ax=aw.$;Y(ax.empty);ax.ul.appendChild(U(aw._li_tpl(ay)))},destroy:function(){}});n("chatlink",{init:function(az){var aB=this,ay=aB.im;var aA=aB.chatlink=new webim.ui.chatlink(null,az).bind("select",function(aC){aB.addChat("buddy",aC);aB.layout.focusChat("buddy",aC)});var ax=function(aC){return aC.show!="invisible"&&aC.presence=="online"};var aw=function(aC){return aC.show=="invisible"};ay.buddy.bind("online",function(aC){aA.add(k(aC,ax))}).bind("update",function(aC){aA.add(k(aC,ax));aA.remove(k(aC,aw))}).bind("offline",function(aC){aA.remove(aC)})},ready:function(aw){aw.stranger_ids=this.chatlink.idsArray()},go:function(){this.chatlink.remove(this.im.data.user)},stop:function(){this.chatlink.removeAll()}});l("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){var aI=this,aA=aI.element,aO=aI.list={},aC=aI.options,ay=aI.anthors={},aE=aC.link_href,aK=aC.space_href,aH=aC.space_id,ax=aC.off_link_class,aw=aC.space_class,aF=aC.space_wrap||K,aQ=aC.link_wrap||K;function aG(aW,aV){if(!aW){return false}var aS=aV.length;for(var aU=0;aU<aS;aU++){var aT=aV[aU].exec(aW);if(aT&&aT[1]){return aT[1]}}return false}var aR=aQ.getElementsByTagName("a"),aP;aR&&at(aR,function(aS,aT){var aV=aG(aT.href,aE),aU=aT.innerHTML;if(aV&&af(aT).length==0&&aU&&(!aT.className||!ax||!ax.test(aT.className))){ay[aV]?ay[aV].push(aT):(ay[aV]=[aT]);aO[aV]={id:aV,name:aU}}});var aJ=aG(an.location.href,aK);if(aJ){aO[aJ]=W(aO[aJ],{id:aJ});var aD=aF.getElementsByTagName("*"),aL=aD.length,az,aB,aM;for(var aN=0;aN<aL;aN++){az=aD[aN],aB=az.className,aM=az.id;if((aw&&aw.test(aB))||(aH&&aH.test(aM))){az=af(az);if(az.length){az=az[az.length-1];ay[aJ]?ay[aJ].push(az):(ay[aJ]=[az])}break}}}},_temp:function(aw){var ax=this;var ay=U(V('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',aw));M(ay,"click",function(az){ax.trigger("select",this.id);ac(az);z(az)});return ay},idsArray:function(){var aw=[];at(this.list,function(ay,ax){aw.push(ay)});return aw},add:function(ay){var aE=this,aC=aE.list,aB=aE.anthors,aw=ay.length,az,aG,aA,aD,aF;for(az=0;az<aw;az++){aG=ay[az];if(aG.id&&(aA=aG.uid)&&(aD=aC[aA])){aF=aB[aA];if(!aD.elements&&aF){aD.elements=[];for(var ax=0;ax<aF.length;ax++){if(aF[ax].tagName.toLowerCase()=="li"){aD.elements[ax]=K.createElement("li");aD.elements[ax].appendChild(aE._temp({id:aG.id,title:"",text:Q("chat with me")}))}else{aD.elements[ax]=aE._temp({id:aG.id,title:Q("chat with",{name:aD.name}),text:""})}}}aF&&at(aF,function(aI,aH){aH.parentNode.insertBefore(aD.elements[aI],aH.nextSibling)})}}},remove:function(ax){var aD=this,aB=aD.list,aA=aD.anthors,aw=ax.length,ay,aF,az,aC,aE;for(ay=0;ay<aw;ay++){aF=ax[ay];if(aF.id&&(az=aF.uid)&&(aC=aB[az])){aC.elements&&at(aC.elements,function(aH,aG){J(aG)})}}},removeAll:function(){at(this.list,function(ax,aw){aw.elements&&at(aw.elements,function(az,ay){J(ay)})})}});y("notification",{url:"webim/notifications"},{_init:function(){var aw=this;if(aw.options.jsonp){aw.request=i}else{aw.request=ak}},grep:function(aw,ax){return aw&&aw.text},handle:function(ax){var aw=this;ax=k(ag(ax),aw.grep);if(ax.length){aw.trigger("data",[ax])}},load:function(){var aw=this,ax=aw.options;aw.request({url:ax.url,cache:false,dataType:"json",context:aw,success:aw.handle})}});n("notification",{init:function(ax){var aA=this,aw=aA.im,az=aA.layout;var ay=aA.notification=new r.notification(null,ax);var aB=aw.notification=new webim.notification(null,{jsonp:aw.options.jsonp});az.addWidget(ay,{title:Q("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});aB.bind("data",function(aC){ay.window.notifyUser("information","+"+aC.length);ay.add(aC)});setTimeout(function(){aB.load()},2000)}});l("notification",{template:'<div id="webim-notification" class="webim-notification">		<ul id=":ul"><%=list%></ul>			<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>				</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var aw=this,ay=aw.element,ax=aw.options;var az=ax.window;ax.data&&ax.data.length&&Y(aw.$.empty)},template:function(){var ax=this,aw=[],ay=ax.options.data;ay&&at(ay,function(az,aA){aw.push(ax._li_tpl(aA))});return V(ax.options.template,{list:aw.join("")})},_li_tpl:function(aw){return V(this.options.tpl_li,{text:aw.text,link:aw.link,target:aw.isExtlink?"_blank":""})},_fitUI:function(){var aw=this.element;if(aw.clientHeight>300){aw.style.height=300+"px"}},add:function(ay){var aw=this;if(a(ay)){at(ay,function(az,aA){aw.add(aA)});return}var ax=aw.$;Y(ax.empty);ax.ul.appendChild(U(aw._li_tpl(ay)))},destroy:function(){}})})(window,document);